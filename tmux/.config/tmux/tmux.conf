# ============================================================================
# Variables y configuración base
# ============================================================================

# Definir rutas base directamente en tmux.conf
%hidden TMUX_CONFIG_HOME="$HOME/.config/tmux"
%hidden TMUX_SESSION_SCRIPTS="$HOME/.config/tmux/scripts/session"

# Definir rutas de scripts usando las variables base
%hidden NAVIGATE_SCRIPT="$TMUX_SESSION_SCRIPTS/navigate.sh"
%hidden HOOK_SESSION_CLOSED="$TMUX_SESSION_SCRIPTS/hook_session_closed.sh"
%hidden HOOK_AFTER_RENAME="$TMUX_SESSION_SCRIPTS/hook_after_rename_window.sh"
%hidden HOOK_AFTER_KILL="$TMUX_SESSION_SCRIPTS/hook_after_kill_pane.sh"
%hidden MAIN_SCRIPT="$TMUX_SESSION_SCRIPTS/main.sh"

%hidden STREAMUX="$TMUX_CONFIG_HOME/scripts/streamux.sh"
%hidden STREAMUX_KILL="$TMUX_CONFIG_HOME/scripts/streamuxkill.sh"

unbind r
bind r source-file $HOME/.config/tmux/tmux.conf

set -g prefix M-space
set -g mouse
set -g status
set -g base-index 0

set -g @logo " "
set -g @recording ""
set -g status-interval 1
set -g status-left-length 85
set -g status-left "#{@recording} #[fg=#e6d9ff]#{@logo} #[fg=#9f8fbf]#(TZ="Europe/Madrid" date +%%H:%%M:%%S) - #[fg=#9f8fbf]#S "

set -g window-status-current-format " #[fg=#e6d9ff]#W "
set -g window-status-format " #[fg=#9f8fbf]#W "

set -g message-command-style "bg=#1e1e2e,fg=#e6d9ff"
set -g message-style "bg=#1e1e2e,fg=#9f8fbf"

set -g status-style bg=default
set -g status-right ''
set -g status-justify right

set-option -a terminal-features "tmux-256color:RGB"
set-option -a terminal-overrides "tmux-256color:Tc"
set-option -sg escape-time 10
set-option -g renumber-windows on
set-option -g status-position top
set-option -g history-file ~/.tmux_history
set-option -g mode-keys vi

set-window-option -g pane-base-index 1

setw -g automatic-rename on
setw -g mode-keys vi

# ============================================================================
# Rename bindings
# ============================================================================

bind -n M-r command-prompt "rename-window '%%'"
bind -n M-C-r command-prompt "rename-session '%%'"

# ============================================================================
# Navigation con hooks
# ============================================================================

# Window navigation
bind -n M-n run-shell "$NAVIGATE_SCRIPT next-window"
bind -n M-p run-shell "$NAVIGATE_SCRIPT prev-window"

# Session navigation
bind -n M-C-n run-shell "$NAVIGATE_SCRIPT next-session"
bind -n M-C-p run-shell "$NAVIGATE_SCRIPT prev-session"

# ============================================================================
# Creation bindings
# ============================================================================

# New session (con prompts de rename)
bind -n M-C-w \
  new-session \; \
  command-prompt "rename-session '%%'" \; \
  command-prompt "rename-window '%%'" \; \
  run-shell "$HOOK_WINDOW_CHANGED"

# New window (con prompt de rename)
bind -n M-w \
  new-window -c "#{pane_current_path}" \; \
  command-prompt "rename-window '%%'" \; \
  run-shell "$HOOK_WINDOW_CHANGED"

# ============================================================================
# Utility bindings
# ============================================================================

bind -n M-v copy-mode
bind -n M-h set status

# ============================================================================
# External scripts
# ============================================================================

bind -n M-s run-shell "$STREAMUX"
bind -n M-C-s run-shell "$STREAMUX_KILL"

# ============================================================================
# Lock mode toggle
# ============================================================================

# Lock tmux (disable all keys except unlock)
set -g @locked 0

bind -n M-o \
	set -g @locked 1 \;\
    set -g @logo " " \;\
    set prefix None \;\
    set key-table off

bind -T off M-o \
	set -g @locked 0 \;\
    set -g @logo " " \;\
    set -u prefix \;\
    set -u key-table

# ============================================================================
# Copy mode bindings
# ============================================================================

bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind-key -T copy-mode-vi y send-keys -X copy-selection-and-cancel
bind-key -T copy-mode-vi Escape send-keys -X cancel

# ============================================================================
# Popup bindings
# ============================================================================
# Terminal popup
bind -n M-1 popup -d '#{pane_current_path}' -E -w 80% -h 80%
# Lazygit popup
bind -n M-g popup -B -d '#{pane_current_path}' -E -w 100% -h 100% lazygit
# Btop popup
bind -n M-b popup -B -d '#{pane_current_path}' -E -w 100% -h 100% btop
# Session popup
bind -n M-d popup -B -d '#{pane_current_path}' -E -w 100% -h 100% "$MAIN_SCRIPT"

# ============================================================================
# Hooks
# ============================================================================
set-hook -g session-closed "run-shell '$HOOK_SESSION_CLOSED'"
set-hook -g after-rename-window "run-shell '$HOOK_AFTER_RENAME'"
set-hook -g after-kill-pane "run-shell '$HOOK_AFTER_KILL'"
